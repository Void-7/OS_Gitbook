# 进程同步

## 基本概念

在多道程序环境下，进程是并发执行的，不同进程之间存在着不同的相互制约关系。为了**协调进程之间的相互制约关系**，引入了**进程同步**的概念。

**进程的异步性**：进程的执行次序无法预知。

### 临界资源

虽然多个进程可以共享系统中的各种资源，但其中许多资源一次只能为一个进程所使用，我们把**一次仅允许一个进程使用的资源**称为临界资源。许多物理设备都属于临界资源，如打印机等。此外，还有许多**变量、数据**等都可以被若干进程共享，也属于临界资源。

对临界资源的访问，必须互斥地进行，在每个进程中，**访问临界资源的那段代码**称为**临界区**。为了保证临界资源的正确使用，可以把临界资源的访问过程分成四个部分：

{% tabs %}
{% tab title="进入区" %}
为了进入临界区使用临界资源，在进入区要检查可否进入临界区，如果可以进入临界区，则应设置正在访问临界区的标志，以阻止其他进程同时进入临界区。
{% endtab %}

{% tab title="访问区" %}
进程中访问临界资源的那段代码，又称临界段。
{% endtab %}

{% tab title="退出区" %}
将正在访问临界资源的标志清除（可理解为解锁）。
{% endtab %}

{% tab title="剩余区" %}
代码中的其他部分，做其他处理。
{% endtab %}
{% endtabs %}

```c
do {
    entry section; //进入区
    critical section; //临界区
    exit section; //退出区
    remainder section; //剩余区
} while (true)
```

### 互斥

互斥 互斥亦称间接制约关系。当一个进程进入临界区使用临界资源时，另一个进程必须等待, 当占用临界资源的进程退出临界区后，另一进程才允许去访问此临界资源。

例如，在仅有一台打印机的系统中，有两个进程A和进程B，如果进程A需要打印时, 系统已将打印机分配给进程B,则进程A必须阻塞。一旦进程B将打印机释放，系统便将进程A唤醒，并将其由阻塞状态变为就绪状态。 

为禁止两个进程同时进入临界区，**同步机制**应遵循以下**准则**：

1.**空闲让进**。临界区空闲时，可以允许一个请求进入临界区的进程立即进入临界区。

2.**忙则等待**。当已有进程进入临界区时，其他试图进入临界区的进程必须等待。

3.**有限等待**。对请求访问的进程，应保证能在有限时间内进入临界区。

4.**让权等待**。当进程不能进入临界区时，应立即释放处理器，防止进程忙等待。



### 同步

同步亦称直接制约关系，它是指为完成某种任务而建立的两个或多个进程，这些进程因为需要在某些位置上协调它们的工作次序而等待、传递信息所产生的制约关系。进程间的直接制约关系就是源于它们之间的相互合作。

例如，输入进程A通过单缓冲向进程B提供数据。当该缓冲区空时，进程B不能获得所需数据而阻塞，一旦进程A将数据送入缓冲区，进程B被唤醒。反之，当缓冲区满时，进程A被阻塞，仅当进程B取走缓冲数据时，才唤醒进程A。 



## 进程互斥的软件实现

1. 单标志法
2. 双标志先检查
3. 双标志后检查
4. Peterson算法

### 单标志法

该算法设置一个公用整型变量turn,用于指示被允许进入临界区的进程编号，即若turn=0，则允许P0进程进入临界区。该算法可确保每次只允许一个进程进入临界区。但两个进程必须交替进入临界区，如果某个进程不再进入临界区了，那么另一个进程也将无法进入临界区（违背“空闲让进”的同步机制准则）这样很容易造成资源利用的不充分。 

```c
while(turn!=0);
critical section;
turn=1;
remainder section;
```

引用《操作系统：精髓与设计原理》P122关于其缺点的一段话：

> 这种解决方案保证了互斥属性，但有两个缺点。第一，进程必须严格交替使用它们的临界区，因此执行的步调由二者中较慢的进程决定。。若P0在1小时内仅使用临界区1次而P1要以1000次/小时的速率使用临界区，则P1必须适应P0的节奏。更为严重的问题是，若一个进程终止，另一个进程就会被永久阻塞。无论进程是在临界区内终止还是在临界区外终止，都会发生这种情况。

### 双标志先检查



### 双标志后检查



### Peterson算法



